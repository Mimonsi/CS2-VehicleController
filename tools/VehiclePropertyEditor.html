<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vehicle Controller - Vehicle Property Tuner(JSON)</title>
    <style>
        :root { --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa3b2; --accent:#7aa2f7; --card:#151823; --line:#23283a; }
        html,body{height:100%}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--fg)}
        header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.85));backdrop-filter:saturate(140%) blur(8px);z-index:5;border-bottom:1px solid var(--line)}
        .wrap{max-width:1150px;margin:0 auto;padding:14px 18px}
        h1{font-size:20px;margin:4px 0}
        .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
        .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
        input[type="file"]{display:none}
        .btn{background:#1d2333;color:#e6e6e6;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
        .btn.primary{background:var(--accent);border-color:#5c7bd9;color:#080b12}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#1a1f2e;border:1px solid var(--line)}
        .pill input[type="search"], .pill input[type="number"], .pill input[type="text"]{background:transparent;color:var(--fg);border:none;outline:none;min-width:120px}
        .grid{margin:16px 0}
        table{width:100%;border-collapse:separate;border-spacing:0 10px}
        thead th{font-size:12px;font-weight:600;text-transform:uppercase;color:var(--muted);letter-spacing:.06em;text-align:left}
        tbody tr{background:var(--card);border:1px solid var(--line)}
        tbody td{padding:10px 10px;vertical-align:middle;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
        tbody tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
        tbody tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
        .prefab{font-weight:600}
        .muted{color:var(--muted);font-size:12px}
        .w100{width:100%}
        .sliderCell{min-width:290px}
        .num{width:90px; padding:6px 8px; border-radius:8px; border:1px solid var(--line); background:#111522; color:var(--fg)}
        .num.small{width:80px}
        input[type=range]{width:100%}
        .badgelite{font-size:12px;color:#b3c0ff;background:#1a2440;border:1px solid #283555;border-radius:999px;padding:3px 8px}
        .footer{color:var(--muted);font-size:12px;margin:10px 0}
    </style>
</head>
<body>
<header>
    <div class="wrap">
        <h1>Vehicle Property Tuner <span class="muted">– Adjust km/h per prefab, edit Name/Version, export as JSON</span></h1>
        <div class="row" style="gap:12px">
            <label class="btn">
                <input id="fileInput" type="file" accept="application/json" />
                Load JSON…
            </label>
            <button id="downloadBtn" class="btn primary" disabled>Export JSON</button>
            <button id="resetBtn" class="btn" disabled>Reset changes</button>
            <label class="pill"><b>Name:</b> <input id="setName" type="text" placeholder="Name" /></label>
            <label class="pill"><b>Version:</b> <input id="setVersion" type="number" min="0" /></label>
            <label class="pill">
                <input id="search" type="search" placeholder="Search prefab…" />
            </label>
            <label class="pill"><input type="checkbox" id="editedOnly"/> edited only</label>
            <label class="pill">Slider range: <input id="rangeMin" class="num small" type="number" value="0" step="10"/>–<input id="rangeMax" class="num small" type="number" value="400" step="10"/> km/h</label>
        </div>
    </div>
</header>

<div class="wrap">
    <div class="row" style="margin-top:10px;gap:10px">
        <button id="addPrefabBtn" class="btn">+ Add prefab</button>
    </div>
    <div id="meta" class="footer"></div>
    <div class="grid">
        <table>
            <thead>
            <tr>
                <th style="width:280px">Prefab</th>
                <th class="sliderCell">MaxSpeed (km/h)</th>
                <th>Value</th>
                <th>Acceleration</th>
                <th>Braking</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const tbody = document.getElementById('tbody');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const searchInput = document.getElementById('search');
    const editedOnly = document.getElementById('editedOnly');
    const rangeMin = document.getElementById('rangeMin');
    const rangeMax = document.getElementById('rangeMax');
    const meta = document.getElementById('meta');
    const setName = document.getElementById('setName');
    const setVersion = document.getElementById('setVersion');
    const addPrefabBtn = document.getElementById('addPrefabBtn');

    let original = null;
    let working = null;
    let order = [];

    const msToKmh = (ms) => (ms == null ? '' : (Number(ms) * 3.6));
    const kmhToMs = (kmh) => (kmh == null ? null : (Number(kmh) / 3.6));

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function setStateFromJson(obj){
        original = deepClone(obj);
        working = deepClone(obj);
        order = Object.keys(working.Entries || {}).sort((a,b)=>a.localeCompare(b,'en'));
        setName.value = working.Name || '';
        setVersion.value = working.Version ?? 0;
        renderTable();
        updateMeta();
        downloadBtn.disabled = false;
        resetBtn.disabled = false;
    }

    fileInput.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        try{
            const json = JSON.parse(text);
            if(!json || typeof json !== 'object' || !json.Entries){
                alert('Invalid format: expected an object with an "Entries" field.');
                return;
            }
            setStateFromJson(json);
        }catch(err){
            alert('Could not parse file: '+err.message);
        }
    });

    function renderTable(){
        const q = (searchInput.value||'').toLowerCase();
        const onlyEdited = editedOnly.checked;
        const min = Number(rangeMin.value)||0;
        const max = Number(rangeMax.value)||400;

        tbody.innerHTML = '';
        const entries = working.Entries;
        order = Object.keys(entries);
        for(const key of order){
            const e0 = original.Entries[key] || {};
            const e  = entries[key];
            const name = e.PrefabName || key;
            const currKmh = msToKmh(e.MaxSpeed);
            const origKmh = msToKmh(e0.MaxSpeed);
            const isEdited = Math.abs((currKmh||0) - (origKmh||0)) > 1e-6 || (e.Acceleration!==e0.Acceleration) || (e.Braking!==e0.Braking);

            if(q && !name.toLowerCase().includes(q)) continue;
            if(onlyEdited && !isEdited) continue;

            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td><div class="prefab">${escapeHtml(name)}</div></td>
          <td class="sliderCell"><input type="range" min="${min}" max="${max}" step="1" value="${(currKmh||0).toFixed(0)}" /></td>
          <td><input class="num" type="number" step="0.1" value="${currKmh.toFixed(1)}" /></td>
          <td><input class="num" type="number" step="0.1" value="${Number(e.Acceleration ?? 0)}" /></td>
          <td><input class="num" type="number" step="0.1" value="${Number(e.Braking ?? 0)}" /></td>
          <td><button class="btn" style="padding:4px 8px" data-action="del">Delete</button></td>`;

            const [slider, num, acc, brk, del] = tr.querySelectorAll('input,button');
            slider.addEventListener('input', ()=>{ num.value = slider.value; e.MaxSpeed = kmhToMs(slider.value); });
            num.addEventListener('input', ()=>{ slider.value = num.value; e.MaxSpeed = kmhToMs(num.value); });
            acc.addEventListener('input', ()=> e.Acceleration = Number(acc.value));
            brk.addEventListener('input', ()=> e.Braking = Number(brk.value));
            del.addEventListener('click', ()=>{ if(confirm(`Delete prefab ${name}?`)){ delete working.Entries[key]; renderTable(); updateMeta(); }});
            tbody.appendChild(tr);
        }
    }

    function updateMeta(){
        const total = Object.keys(working.Entries||{}).length;
        meta.innerHTML = `Name: <b>${escapeHtml(working.Name??'—')}</b> · Version: <b>${escapeHtml(working.Version??'—')}</b> · Entries: <b>${total}</b>`;
    }

    setName.addEventListener('input', ()=> working.Name = setName.value);
    setVersion.addEventListener('input', ()=> working.Version = parseInt(setVersion.value)||0);

    resetBtn.addEventListener('click', ()=>{ if(!original) return; working = deepClone(original); renderTable(); updateMeta(); });

    addPrefabBtn.addEventListener('click', ()=>{
        const name = prompt('Name of new prefab?');
        if(!name) return;
        working.Entries[name] = { PrefabName: name, MaxSpeed: kmhToMs(100), Acceleration: 10, Braking: 10 };
        renderTable();
        updateMeta();
    });

    downloadBtn.addEventListener('click', ()=>{
        const out = deepClone(working);
        for(const k of Object.keys(out.Entries||{})){
            const e = out.Entries[k];
            if(typeof e.MaxSpeed === 'number') e.MaxSpeed = Number(e.MaxSpeed.toFixed(6));
        }
        const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.download = `${(out.Name||'Exported')}_edited.json`;
        a.href = URL.createObjectURL(blob);
        a.click();
        setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }
</script>
</body>
</html>
